<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>💰 متابعة المصاريف</title>
  <style>
    body { font-family: Tahoma, Arial, sans-serif; direction: rtl; background: #f9fafb; padding: 20px; }
    h2, h3 { text-align: center; margin-bottom: 15px; color: #2c3e50; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 12px; }
    input, select { padding: 10px; border: 1px solid #bbb; border-radius: 6px; min-width: 150px; }
    button { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    button.save { background: #3498db; color: white; }
    button.reset { background: #f39c12; color: white; }
    button.delete { background: #e74c3c; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #3498db; color: white; }
    .totals { margin-top: 10px; text-align: center; font-weight: bold; }
    #summary, #weeklyReport { font-size: 15px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); line-height: 1.8; margin-top: 20px; }
    #summary table, #weeklyReport table { width: 100%; border-collapse: collapse; }
    #summary th, #summary td, #weeklyReport th, #weeklyReport td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    #summary th, #weeklyReport th { background: #2980b9; color: white; }
    .good { color: #27ae60; font-weight: bold; }
    .bad { color: #e74c3c; font-weight: bold; }
  </style>
</head>
<body>
  <h2>💰 متابعة المصاريف الشهرية والأسبوعية</h2>

  <div class="card">
    <h3>💵 إدخال الراتب الشهري</h3>
    <div class="row">
      <input type="number" id="salary" placeholder="الراتب الشهري">
      <button class="save" onclick="setSalary()">حفظ</button>
      <button class="reset" onclick="resetSalary()">إعادة ضبط</button>
    </div>
  </div>

  <div class="card">
    <h3>🏠 المصاريف الثابتة (شهرية)</h3>
    <div class="row">
      <input type="text" id="fixedDesc" placeholder="الوصف">
      <input type="number" id="fixedAmount" placeholder="المبلغ">
      <button class="save" onclick="addFixedExpense()">إضافة</button>
    </div>
    <table id="fixedTable">
      <thead>
        <tr><th>الوصف</th><th>المبلغ</th><th>إجراء</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="totals" id="fixedTotal"></div>
  </div>

  <div class="card">
    <h3>📅 المصاريف المتغيرة (أسبوعية)</h3>
    <div class="totals" id="suggestedLimit"></div>
    <div class="totals" id="userLimitInfo"></div>
    <div class="row">
      <input type="number" id="userWeeklyLimit" placeholder="حد أسبوعي (يدوي)">
      <button class="save" onclick="setUserWeeklyLimit()">حفظ</button>
      <button class="reset" onclick="resetWeeklyLimit()">إعادة ضبط</button>
    </div>
    <div class="row">
      <input type="text" id="desc" placeholder="الوصف">
      <input type="number" id="amount" placeholder="المبلغ">
      <select id="category">
        <option>🍔 أكل</option>
        <option>🎮 ترفيه</option>
        <option>🏠 أخرى</option>
      </select>
      <button class="save" onclick="addExpense()">إضافة</button>
    </div>
    <table id="expensesTable">
      <thead>
        <tr><th>الأسبوع</th><th>التاريخ</th><th>الوصف</th><th>الفئة</th><th>المبلغ</th><th>إجراء</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="totals" id="variableTotal"></div>
  </div>

  <div class="card" id="weeklyReport">
    <h3>📊 تقرير الأسابيع</h3>
    <div class="totals" id="weeklyLimitInfo"></div>
    <div style="margin-bottom:10px; text-align:center; color:#555;">
      ℹ️ فترة الحساب: 4 أسابيع ثابتة من 27 الشهر → 26 الشهر اللي بعده
    </div>
    <div id="weeklyReportContent"></div>
  </div>

  <div class="card" id="summary"></div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      let salary = +localStorage.getItem("salary") || 0;
      let fixedExpenses = JSON.parse(localStorage.getItem("fixedExpenses") || "[]");
      let variableExpenses = JSON.parse(localStorage.getItem("variableExpenses") || "[]");
      let userWeeklyLimit = +localStorage.getItem("userWeeklyLimit") || 0;
      const totalWeeks = 4;

      function saveData() {
        localStorage.setItem("salary", salary);
        localStorage.setItem("fixedExpenses", JSON.stringify(fixedExpenses));
        localStorage.setItem("variableExpenses", JSON.stringify(variableExpenses));
        localStorage.setItem("userWeeklyLimit", userWeeklyLimit);
      }

      function getWeekFromSalary(date) {
        let year = date.getFullYear();
        let month = date.getMonth();
        let cycleStart = new Date(year, month, 27);
        if (date < cycleStart) {
          month -= 1;
          cycleStart = new Date(year, month, 27);
        }
        let diffDays = Math.floor((date - cycleStart) / (1000 * 60 * 60 * 24));
        let week = Math.floor(diffDays / 7) + 1;
        if (week > totalWeeks) week = totalWeeks;
        return week;
      }

      function renderFixedExpenses() {
        const tbody = document.querySelector("#fixedTable tbody");
        tbody.innerHTML = "";
        let total = 0;
        fixedExpenses.forEach((f, i) => {
          total += f.amount;
          const row = `<tr>
            <td>${f.desc}</td>
            <td>${f.amount}</td>
            <td><button class="delete" onclick="deleteFixed(${i})">🗑️ حذف</button></td>
          </tr>`;
          tbody.innerHTML += row;
        });
        document.getElementById("fixedTotal").innerText = "مجموع الثابتة: " + total + " ريال";
      }

      function renderVariableExpenses() {
        const tbody = document.querySelector("#expensesTable tbody");
        tbody.innerHTML = "";
        let total = 0;
        const today = new Date();
        const currentWeek = getWeekFromSalary(today);

        variableExpenses
          .filter(e => e.week === currentWeek)
          .forEach((e, i) => {
            total += e.amount;
            const row = `<tr>
              <td>${e.week}</td>
              <td>${e.date}</td>
              <td>${e.desc}</td>
              <td>${e.category}</td>
              <td>${e.amount}</td>
              <td><button class="delete" onclick="deleteVariable(${i})">🗑️ حذف</button></td>
            </tr>`;
            tbody.innerHTML += row;
          });

        document.getElementById("variableTotal").innerText =
          "💸 مصاريف هذا الأسبوع: " + total + " ريال";
      }

      function renderWeeklyReport() {
        let weeks = {};
        variableExpenses.forEach(e => {
          weeks[e.week] = (weeks[e.week] || 0) + e.amount;
        });

        let suggested = Math.round((salary - fixedExpenses.reduce((a, b) => a + b.amount, 0)) / totalWeeks);
        let limit = userWeeklyLimit || suggested;

        document.getElementById("weeklyLimitInfo").innerText =
          userWeeklyLimit
            ? "✍️ الحد الأسبوعي (المستخدم): " + userWeeklyLimit + " ريال"
            : "🎯 الحد الأسبوعي (المقترح): " + suggested + " ريال";

        let html = "<table><thead><tr><th>📅 الأسبوع</th><th>💸 مجموع المصاريف</th><th>📝 الحالة</th></tr></thead><tbody>";
        for (let w = 1; w <= totalWeeks; w++) {
          let spent = weeks[w] || 0;
          let diff = limit - spent;
          let status = diff >= 0 
            ? `<span class='good'>✅ متبقي ${diff} ريال</span>` 
            : `<span class='bad'>❌ تجاوز بـ ${Math.abs(diff)} ريال</span>`;
          html += `<tr><td>${w}</td><td>${spent} ريال</td><td>${status}</td></tr>`;
        }
        html += "</tbody></table>";

        document.getElementById("weeklyReportContent").innerHTML = html;
      }

      function renderSummary() {
        let fixedTotal = fixedExpenses.reduce((a, b) => a + b.amount, 0);
        const today = new Date();
        const currentWeek = getWeekFromSalary(today);

        let currentWeekExpenses = variableExpenses.filter(e => e.week === currentWeek);
        let variableTotal = currentWeekExpenses.reduce((a, b) => a + b.amount, 0);
        let remaining = salary - fixedTotal - variableExpenses.reduce((a, b) => a + b.amount, 0);

        let suggested = Math.round((salary - fixedTotal) / totalWeeks);
        let weeklyLimit = userWeeklyLimit || suggested;
        let weeklyRemaining = weeklyLimit - variableTotal;

        document.getElementById("suggestedLimit").innerText =
          "🎯 المبلغ المقترح للحد الأسبوعي: " + suggested + " ريال";
        document.getElementById("userLimitInfo").innerText =
          "✍️ الحد الأسبوعي (المستخدم): " + (userWeeklyLimit || "غير محدد");

        let html = "<table><thead><tr>" +
          "<th>📅 عدد أسابيع الدورة</th>" +
          "<th>💵 الراتب</th>" +
          "<th>🏠 المصاريف الثابتة</th>" +
          "<th>✍️ الحد الأسبوعي</th>" +
          "<th>💸 مصاريف هذا الأسبوع</th>" +
          "<th>📊 المتبقي من الحد الأسبوعي</th>" +
          "<th>💳 مجموع المصاريف</th>" +
          "<th>📊 المتبقي من الراتب</th>" +
          "</tr></thead><tbody>";

        html += `<tr>
          <td>${totalWeeks}</td>
          <td>${salary}</td>
          <td>${fixedTotal}</td>
          <td>${weeklyLimit}</td>
          <td>${variableTotal}</td>
          <td class="${weeklyRemaining >= 0 ? "good" : "bad"}">${weeklyRemaining}</td>
          <td>${fixedTotal + variableExpenses.reduce((a, b) => a + b.amount, 0)}</td>
          <td class="${remaining >= 0 ? "good" : "bad"}">${remaining}</td>
        </tr>`;

        html += "</tbody></table>";
        document.getElementById("summary").innerHTML = html;
      }

      // Events
      window.setSalary = function() {
        const val = +document.getElementById("salary").value;
        if(val) { salary = val; saveData(); renderAll(); }
      }
      window.resetSalary = function() { salary = 0; saveData(); renderAll(); }
      window.addFixedExpense = function() {
        const desc = document.getElementById("fixedDesc").value;
        const amt = +document.getElementById("fixedAmount").value;
        if(desc && amt) { fixedExpenses.push({desc, amount: amt}); saveData(); renderAll(); }
      }
      window.deleteFixed = function(i) { fixedExpenses.splice(i,1); saveData(); renderAll(); }
      window.addExpense = function() {
        const desc = document.getElementById("desc").value;
        const amt = +document.getElementById("amount").value;
        const cat = document.getElementById("category").value;
        const today = new Date();
        let weekNumber = getWeekFromSalary(today);
        if(desc && amt) {
          variableExpenses.push({ date: today.toLocaleDateString(), desc, amount: amt, category: cat, week: weekNumber });
          saveData(); renderAll();
        }
      }
      window.deleteVariable = function(i) { variableExpenses.splice(i,1); saveData(); renderAll(); }
      window.setUserWeeklyLimit = function() {
        const val = +document.getElementById("userWeeklyLimit").value;
        if(val) { userWeeklyLimit = val; saveData(); renderAll(); }
      }
      window.resetWeeklyLimit = function() { userWeeklyLimit = 0; saveData(); renderAll(); }

      function renderAll() {
        renderFixedExpenses();
        renderVariableExpenses();
        renderWeeklyReport();
        renderSummary();
      }

      renderAll();
    });
  </script>
</body>
</html>
