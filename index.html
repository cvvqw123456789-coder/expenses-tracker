<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ğŸ’° Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</title>
  <style>
    body { font-family: Tahoma, Arial, sans-serif; direction: rtl; background: #f9fafb; padding: 20px; }
    h2, h3 { text-align: center; margin-bottom: 15px; color: #2c3e50; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 12px; }
    input, select { padding: 10px; border: 1px solid #bbb; border-radius: 6px; min-width: 150px; }
    button { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    button.save { background: #3498db; color: white; }
    button.reset { background: #f39c12; color: white; }
    button.delete { background: #e74c3c; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #3498db; color: white; }
    .totals { margin-top: 10px; text-align: center; font-weight: bold; }
    #summary, #weeklyReport { font-size: 15px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); line-height: 1.8; margin-top: 20px; }
    #summary table, #weeklyReport table { width: 100%; border-collapse: collapse; }
    #summary th, #summary td, #weeklyReport th, #weeklyReport td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    #summary th, #weeklyReport th { background: #2980b9; color: white; }
    .good { color: #27ae60; font-weight: bold; }
    .bad { color: #e74c3c; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ğŸ’° Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© ÙˆØ§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h2>

  <div class="card">
    <h3>ğŸ’µ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
    <div class="row">
      <input type="number" id="salary" placeholder="Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ">
      <button class="save" onclick="setSalary()">Ø­ÙØ¸</button>
      <button class="reset" onclick="resetSalary()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ  Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ø´Ù‡Ø±ÙŠØ©)</h3>
    <div class="row">
      <input type="text" id="fixedDesc" placeholder="Ø§Ù„ÙˆØµÙ">
      <input type="number" id="fixedAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
      <button class="save" onclick="addFixedExpense()">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
    <table id="fixedTable">
      <thead>
        <tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="totals" id="fixedTotal"></div>
  </div>

  <div class="card">
    <h3>ğŸ“… Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø© (Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©)</h3>
    <div class="totals" id="suggestedLimit"></div>
    <div class="totals" id="userLimitInfo"></div>
    <div class="row">
      <input type="number" id="userWeeklyLimit" placeholder="Ø­Ø¯ Ø£Ø³Ø¨ÙˆØ¹ÙŠ (ÙŠØ¯ÙˆÙŠ)">
      <button class="save" onclick="setUserWeeklyLimit()">Ø­ÙØ¸</button>
      <button class="reset" onclick="resetWeeklyLimit()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>
    <div class="row">
      <input type="text" id="desc" placeholder="Ø§Ù„ÙˆØµÙ">
      <input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
      <select id="category">
        <option>ğŸ” Ø£ÙƒÙ„</option>
        <option>ğŸ® ØªØ±ÙÙŠÙ‡</option>
        <option>ğŸ  Ø£Ø®Ø±Ù‰</option>
      </select>
      <button class="save" onclick="addExpense()">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
    <table id="expensesTable">
      <thead>
        <tr><th>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="totals" id="variableTotal"></div>
  </div>

  <div class="card" id="weeklyReport">
    <h3>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</h3>
    <div class="totals" id="weeklyLimitInfo"></div>
    <div style="margin-bottom:10px; text-align:center; color:#555;">
      â„¹ï¸ ÙØªØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨: 4 Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø«Ø§Ø¨ØªØ© Ù…Ù† 27 Ø§Ù„Ø´Ù‡Ø± â†’ 26 Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡
    </div>
    <div id="weeklyReportContent"></div>
  </div>

  <div class="card" id="summary"></div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      let salary = +localStorage.getItem("salary") || 0;
      let fixedExpenses = JSON.parse(localStorage.getItem("fixedExpenses") || "[]");
      let variableExpenses = JSON.parse(localStorage.getItem("variableExpenses") || "[]");
      let userWeeklyLimit = +localStorage.getItem("userWeeklyLimit") || 0;
      const totalWeeks = 4;

      function saveData() {
        localStorage.setItem("salary", salary);
        localStorage.setItem("fixedExpenses", JSON.stringify(fixedExpenses));
        localStorage.setItem("variableExpenses", JSON.stringify(variableExpenses));
        localStorage.setItem("userWeeklyLimit", userWeeklyLimit);
      }

      function getWeekFromSalary(date) {
        let year = date.getFullYear();
        let month = date.getMonth();
        let cycleStart = new Date(year, month, 27);
        if (date < cycleStart) {
          month -= 1;
          cycleStart = new Date(year, month, 27);
        }
        let diffDays = Math.floor((date - cycleStart) / (1000 * 60 * 60 * 24));
        let week = Math.floor(diffDays / 7) + 1;
        if (week > totalWeeks) week = totalWeeks;
        return week;
      }

      function renderFixedExpenses() {
        const tbody = document.querySelector("#fixedTable tbody");
        tbody.innerHTML = "";
        let total = 0;
        fixedExpenses.forEach((f, i) => {
          total += f.amount;
          const row = `<tr>
            <td>${f.desc}</td>
            <td>${f.amount}</td>
            <td><button class="delete" onclick="deleteFixed(${i})">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
          </tr>`;
          tbody.innerHTML += row;
        });
        document.getElementById("fixedTotal").innerText = "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø«Ø§Ø¨ØªØ©: " + total + " Ø±ÙŠØ§Ù„";
      }

      function renderVariableExpenses() {
        const tbody = document.querySelector("#expensesTable tbody");
        tbody.innerHTML = "";
        let total = 0;
        const today = new Date();
        const currentWeek = getWeekFromSalary(today);

        variableExpenses
          .filter(e => e.week === currentWeek)
          .forEach((e, i) => {
            total += e.amount;
            const row = `<tr>
              <td>${e.week}</td>
              <td>${e.date}</td>
              <td>${e.desc}</td>
              <td>${e.category}</td>
              <td>${e.amount}</td>
              <td><button class="delete" onclick="deleteVariable(${i})">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
            </tr>`;
            tbody.innerHTML += row;
          });

        document.getElementById("variableTotal").innerText =
          "ğŸ’¸ Ù…ØµØ§Ø±ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: " + total + " Ø±ÙŠØ§Ù„";
      }

      function renderWeeklyReport() {
        let weeks = {};
        variableExpenses.forEach(e => {
          weeks[e.week] = (weeks[e.week] || 0) + e.amount;
        });

        let suggested = Math.round((salary - fixedExpenses.reduce((a, b) => a + b.amount, 0)) / totalWeeks);
        let limit = userWeeklyLimit || suggested;

        document.getElementById("weeklyLimitInfo").innerText =
          userWeeklyLimit
            ? "âœï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…): " + userWeeklyLimit + " Ø±ÙŠØ§Ù„"
            : "ğŸ¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Ø§Ù„Ù…Ù‚ØªØ±Ø­): " + suggested + " Ø±ÙŠØ§Ù„";

        let html = "<table><thead><tr><th>ğŸ“… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th><th>ğŸ’¸ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</th><th>ğŸ“ Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>";
        for (let w = 1; w <= totalWeeks; w++) {
          let spent = weeks[w] || 0;
          let diff = limit - spent;
          let status = diff >= 0 
            ? `<span class='good'>âœ… Ù…ØªØ¨Ù‚ÙŠ ${diff} Ø±ÙŠØ§Ù„</span>` 
            : `<span class='bad'>âŒ ØªØ¬Ø§ÙˆØ² Ø¨Ù€ ${Math.abs(diff)} Ø±ÙŠØ§Ù„</span>`;
          html += `<tr><td>${w}</td><td>${spent} Ø±ÙŠØ§Ù„</td><td>${status}</td></tr>`;
        }
        html += "</tbody></table>";

        document.getElementById("weeklyReportContent").innerHTML = html;
      }

      function renderSummary() {
        let fixedTotal = fixedExpenses.reduce((a, b) => a + b.amount, 0);
        const today = new Date();
        const currentWeek = getWeekFromSalary(today);

        let currentWeekExpenses = variableExpenses.filter(e => e.week === currentWeek);
        let variableTotal = currentWeekExpenses.reduce((a, b) => a + b.amount, 0);
        let remaining = salary - fixedTotal - variableExpenses.reduce((a, b) => a + b.amount, 0);

        let suggested = Math.round((salary - fixedTotal) / totalWeeks);
        let weeklyLimit = userWeeklyLimit || suggested;
        let weeklyRemaining = weeklyLimit - variableTotal;

        document.getElementById("suggestedLimit").innerText =
          "ğŸ¯ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ: " + suggested + " Ø±ÙŠØ§Ù„";
        document.getElementById("userLimitInfo").innerText =
          "âœï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…): " + (userWeeklyLimit || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯");

        let html = "<table><thead><tr>" +
          "<th>ğŸ“… Ø¹Ø¯Ø¯ Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø©</th>" +
          "<th>ğŸ’µ Ø§Ù„Ø±Ø§ØªØ¨</th>" +
          "<th>ğŸ  Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©</th>" +
          "<th>âœï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</th>" +
          "<th>ğŸ’¸ Ù…ØµØ§Ø±ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th>" +
          "<th>ğŸ“Š Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</th>" +
          "<th>ğŸ’³ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</th>" +
          "<th>ğŸ“Š Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨</th>" +
          "</tr></thead><tbody>";

        html += `<tr>
          <td>${totalWeeks}</td>
          <td>${salary}</td>
          <td>${fixedTotal}</td>
          <td>${weeklyLimit}</td>
          <td>${variableTotal}</td>
          <td class="${weeklyRemaining >= 0 ? "good" : "bad"}">${weeklyRemaining}</td>
          <td>${fixedTotal + variableExpenses.reduce((a, b) => a + b.amount, 0)}</td>
          <td class="${remaining >= 0 ? "good" : "bad"}">${remaining}</td>
        </tr>`;

        html += "</tbody></table>";
        document.getElementById("summary").innerHTML = html;
      }

      // Events
      window.setSalary = function() {
        const val = +document.getElementById("salary").value;
        if(val) { salary = val; saveData(); renderAll(); }
      }
      window.resetSalary = function() { salary = 0; saveData(); renderAll(); }
      window.addFixedExpense = function() {
        const desc = document.getElementById("fixedDesc").value;
        const amt = +document.getElementById("fixedAmount").value;
        if(desc && amt) { fixedExpenses.push({desc, amount: amt}); saveData(); renderAll(); }
      }
      window.deleteFixed = function(i) { fixedExpenses.splice(i,1); saveData(); renderAll(); }
      window.addExpense = function() {
        const desc = document.getElementById("desc").value;
        const amt = +document.getElementById("amount").value;
        const cat = document.getElementById("category").value;
        const today = new Date();
        let weekNumber = getWeekFromSalary(today);
        if(desc && amt) {
          variableExpenses.push({ date: today.toLocaleDateString(), desc, amount: amt, category: cat, week: weekNumber });
          saveData(); renderAll();
        }
      }
      window.deleteVariable = function(i) { variableExpenses.splice(i,1); saveData(); renderAll(); }
      window.setUserWeeklyLimit = function() {
        const val = +document.getElementById("userWeeklyLimit").value;
        if(val) { userWeeklyLimit = val; saveData(); renderAll(); }
      }
      window.resetWeeklyLimit = function() { userWeeklyLimit = 0; saveData(); renderAll(); }

      function renderAll() {
        renderFixedExpenses();
        renderVariableExpenses();
        renderWeeklyReport();
        renderSummary();
      }

      renderAll();
    });
  </script>
</body>
</html>
